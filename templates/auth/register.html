{% extends "base.html" %}
{% load static %}
{% block title %}Register | BRFN{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">

<style>
  /* Register-only layout (self-contained) */
  .page-register .phone-split {
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 520px;
  }

  .page-register .phone-country-select {
    width: 140px;
    min-width: 140px;
    padding: 14px 14px;
    font-size: 1.05rem;
    line-height: 1.2;
    border-radius: 10px;
  }

  .page-register .phone-number-input {
    flex: 1 1 auto;
    min-width: 180px;
    padding: 14px 14px;
    font-size: 1.05rem;
    line-height: 1.2;
    border-radius: 10px;
  }

  .page-register .phone-country-select,
  .page-register .phone-number-input {
    box-sizing: border-box;
  }

  /* Name split */
  .page-register .name-split {
    display: flex;
    gap: 12px;
    max-width: 520px;
  }
  .page-register .name-split > div {
    flex: 1 1 0;
  }
  .page-register .name-input {
    padding: 14px 14px;
    font-size: 1.05rem;
    line-height: 1.2;
    border-radius: 10px;
  }

  /* Hide real Django fields (we fill via JS) */
  .page-register .hidden-field {
    display: none !important;
  }
</style>
{% endblock %}

{% block content %}
<section class="auth-card page-register">
  <h1>Register</h1>
  <p>Select the account type you want to create.</p>

  <div class="form-row">
    <label for="accountType">Account type</label>
    <select id="accountType" class="form-control">
      <option value="customer" selected>Customer (Individual)</option>
      <option value="producer">Producer</option>
    </select>
  </div>

  <!-- CUSTOMER -->
  <div id="customerForm">
    <h2>Customer details</h2>

    <form method="post" action="{% url 'accounts:register_customer' %}" novalidate data-phone-form="customer" data-name-form="customer">
      {% csrf_token %}

      {% if customer_form.non_field_errors %}
        <div class="message message--error" role="alert">
          {% for err in customer_form.non_field_errors %}{{ err }}{% endfor %}
        </div>
      {% endif %}

      <!-- NAME (UI split) -->
      <div class="form-row">
        <label>Name</label>

        <div class="hidden-field django-fullname-field">
          {{ customer_form.full_name }}
        </div>

        <div class="name-split" data-name-split="customer">
          <div>
            <input class="form-control name-input first-name-input" type="text" placeholder="First name" autocomplete="given-name" />
          </div>
          <div>
            <input class="form-control name-input last-name-input" type="text" placeholder="Last name" autocomplete="family-name" />
          </div>
        </div>

        {% for e in customer_form.full_name.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <!-- EMAIL -->
      <div class="form-row">
        <label for="{{ customer_form.email.id_for_label }}">Email</label>
        {{ customer_form.email }}
        {% for e in customer_form.email.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <!-- PHONE (UI split) -->
      <div class="form-row">
        <label>Phone</label>

        <div class="hidden-field django-phone-field">
          {{ customer_form.phone }}
        </div>

        <div class="phone-split" data-phone-split="customer">
          <select class="form-control phone-country-select" autocomplete="tel-country-code">
            <option value="44" selected>ğŸ‡¬ğŸ‡§ +44</option>
            <option value="353">ğŸ‡®ğŸ‡ª +353</option>
            <option value="1">ğŸ‡ºğŸ‡¸ +1</option>
            <option value="1">ğŸ‡¨ğŸ‡¦ +1</option>
            <option value="61">ğŸ‡¦ğŸ‡º +61</option>
            <option value="64">ğŸ‡³ğŸ‡¿ +64</option>
            <option value="33">ğŸ‡«ğŸ‡· +33</option>
            <option value="49">ğŸ‡©ğŸ‡ª +49</option>
            <option value="39">ğŸ‡®ğŸ‡¹ +39</option>
            <option value="34">ğŸ‡ªğŸ‡¸ +34</option>
            <option value="31">ğŸ‡³ğŸ‡± +31</option>
            <option value="32">ğŸ‡§ğŸ‡ª +32</option>
            <option value="41">ğŸ‡¨ğŸ‡­ +41</option>
            <option value="43">ğŸ‡¦ğŸ‡¹ +43</option>
            <option value="351">ğŸ‡µğŸ‡¹ +351</option>
            <option value="46">ğŸ‡¸ğŸ‡ª +46</option>
            <option value="47">ğŸ‡³ğŸ‡´ +47</option>
            <option value="45">ğŸ‡©ğŸ‡° +45</option>
            <option value="358">ğŸ‡«ğŸ‡® +358</option>
            <option value="48">ğŸ‡µğŸ‡± +48</option>
            <option value="420">ğŸ‡¨ğŸ‡¿ +420</option>
            <option value="36">ğŸ‡­ğŸ‡º +36</option>
            <option value="40">ğŸ‡·ğŸ‡´ +40</option>
            <option value="30">ğŸ‡¬ğŸ‡· +30</option>
            <option value="380">ğŸ‡ºğŸ‡¦ +380</option>
            <option value="7">ğŸ‡·ğŸ‡º +7</option>
            <option value="20">ğŸ‡ªğŸ‡¬ +20</option>
            <option value="27">ğŸ‡¿ğŸ‡¦ +27</option>
            <option value="234">ğŸ‡³ğŸ‡¬ +234</option>
            <option value="254">ğŸ‡°ğŸ‡ª +254</option>
            <option value="233">ğŸ‡¬ğŸ‡­ +233</option>
            <option value="212">ğŸ‡²ğŸ‡¦ +212</option>
            <option value="213">ğŸ‡©ğŸ‡¿ +213</option>
            <option value="216">ğŸ‡¹ğŸ‡³ +216</option>
            <option value="971">ğŸ‡¦ğŸ‡ª +971</option>
            <option value="966">ğŸ‡¸ğŸ‡¦ +966</option>
            <option value="974">ğŸ‡¶ğŸ‡¦ +974</option>
            <option value="965">ğŸ‡°ğŸ‡¼ +965</option>
            <option value="973">ğŸ‡§ğŸ‡­ +973</option>
            <option value="968">ğŸ‡´ğŸ‡² +968</option>
            <option value="972">ğŸ‡®ğŸ‡± +972</option>
            <option value="90">ğŸ‡¹ğŸ‡· +90</option>
            <option value="98">ğŸ‡®ğŸ‡· +98</option>
            <option value="92">ğŸ‡µğŸ‡° +92</option>
            <option value="880">ğŸ‡§ğŸ‡© +880</option>
            <option value="91">ğŸ‡®ğŸ‡³ +91</option>
            <option value="94">ğŸ‡±ğŸ‡° +94</option>
            <option value="977">ğŸ‡³ğŸ‡µ +977</option>
            <option value="86">ğŸ‡¨ğŸ‡³ +86</option>
            <option value="81">ğŸ‡¯ğŸ‡µ +81</option>
            <option value="82">ğŸ‡°ğŸ‡· +82</option>
            <option value="65">ğŸ‡¸ğŸ‡¬ +65</option>
            <option value="60">ğŸ‡²ğŸ‡¾ +60</option>
            <option value="62">ğŸ‡®ğŸ‡© +62</option>
            <option value="66">ğŸ‡¹ğŸ‡­ +66</option>
            <option value="84">ğŸ‡»ğŸ‡³ +84</option>
            <option value="63">ğŸ‡µğŸ‡­ +63</option>
            <option value="55">ğŸ‡§ğŸ‡· +55</option>
            <option value="52">ğŸ‡²ğŸ‡½ +52</option>
            <option value="54">ğŸ‡¦ğŸ‡· +54</option>
            <option value="56">ğŸ‡¨ğŸ‡± +56</option>
            <option value="57">ğŸ‡¨ğŸ‡´ +57</option>
            <option value="51">ğŸ‡µğŸ‡ª +51</option>
          </select>

          <input
            class="form-control phone-number-input"
            type="tel"
            inputmode="numeric"
            autocomplete="tel-national"
            placeholder="Phone number"
          />
        </div>

        {% for e in customer_form.phone.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.password.id_for_label }}">Password</label>
        {{ customer_form.password }}
        {% if customer_form.password.help_text %}<small class="form-help">{{ customer_form.password.help_text }}</small>{% endif %}
        {% for e in customer_form.password.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.password_confirm.id_for_label }}">Confirm password</label>
        {{ customer_form.password_confirm }}
        {% for e in customer_form.password_confirm.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.delivery_address.id_for_label }}">Delivery address</label>
        {{ customer_form.delivery_address }}
        {% for e in customer_form.delivery_address.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.postcode.id_for_label }}">Postcode</label>
        {{ customer_form.postcode }}
        {% for e in customer_form.postcode.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label>
          {{ customer_form.terms_accepted }} I accept the <a href="{% url 'accounts:terms_conditions' %}">terms and conditions</a>
        </label>
        {% for e in customer_form.terms_accepted.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <button class="btn btn--primary" type="submit">Create customer account</button>
    </form>
  </div>

  <!-- PRODUCER -->
  <div id="producerForm" style="display:none;">
    <h2>Producer details</h2>

    <form method="post" action="{% url 'accounts:register_producer' %}" novalidate data-phone-form="producer" data-name-form="producer">
      {% csrf_token %}

      {% if producer_form.non_field_errors %}
        <div class="message message--error" role="alert">
          {% for err in producer_form.non_field_errors %}{{ err }}{% endfor %}
        </div>
      {% endif %}

      <!-- NAME (UI split) -->
      <div class="form-row">
        <label>Name</label>

        <div class="hidden-field django-fullname-field">
          {{ producer_form.contact_name }}
        </div>

        <div class="name-split" data-name-split="producer">
          <div>
            <input class="form-control name-input first-name-input" type="text" placeholder="First name" autocomplete="given-name" />
          </div>
          <div>
            <input class="form-control name-input last-name-input" type="text" placeholder="Last name" autocomplete="family-name" />
          </div>
        </div>

        {% for e in producer_form.contact_name.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.email.id_for_label }}">Email</label>
        {{ producer_form.email }}
        {% for e in producer_form.email.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <!-- PHONE (UI split) -->
      <div class="form-row">
        <label>Phone</label>

        <div class="hidden-field django-phone-field">
          {{ producer_form.phone }}
        </div>

        <div class="phone-split" data-phone-split="producer">
          <select class="form-control phone-country-select" autocomplete="tel-country-code">
            <option value="44" selected>ğŸ‡¬ğŸ‡§ +44</option>
            <option value="353">ğŸ‡®ğŸ‡ª +353</option>
            <option value="1">ğŸ‡ºğŸ‡¸ +1</option>
            <option value="1">ğŸ‡¨ğŸ‡¦ +1</option>
            <option value="61">ğŸ‡¦ğŸ‡º +61</option>
            <option value="64">ğŸ‡³ğŸ‡¿ +64</option>
            <option value="33">ğŸ‡«ğŸ‡· +33</option>
            <option value="49">ğŸ‡©ğŸ‡ª +49</option>
            <option value="39">ğŸ‡®ğŸ‡¹ +39</option>
            <option value="34">ğŸ‡ªğŸ‡¸ +34</option>
            <option value="31">ğŸ‡³ğŸ‡± +31</option>
            <option value="32">ğŸ‡§ğŸ‡ª +32</option>
            <option value="41">ğŸ‡¨ğŸ‡­ +41</option>
            <option value="43">ğŸ‡¦ğŸ‡¹ +43</option>
            <option value="351">ğŸ‡µğŸ‡¹ +351</option>
            <option value="46">ğŸ‡¸ğŸ‡ª +46</option>
            <option value="47">ğŸ‡³ğŸ‡´ +47</option>
            <option value="45">ğŸ‡©ğŸ‡° +45</option>
            <option value="358">ğŸ‡«ğŸ‡® +358</option>
            <option value="48">ğŸ‡µğŸ‡± +48</option>
            <option value="420">ğŸ‡¨ğŸ‡¿ +420</option>
            <option value="36">ğŸ‡­ğŸ‡º +36</option>
            <option value="40">ğŸ‡·ğŸ‡´ +40</option>
            <option value="30">ğŸ‡¬ğŸ‡· +30</option>
            <option value="380">ğŸ‡ºğŸ‡¦ +380</option>
            <option value="7">ğŸ‡·ğŸ‡º +7</option>
            <option value="20">ğŸ‡ªğŸ‡¬ +20</option>
            <option value="27">ğŸ‡¿ğŸ‡¦ +27</option>
            <option value="234">ğŸ‡³ğŸ‡¬ +234</option>
            <option value="254">ğŸ‡°ğŸ‡ª +254</option>
            <option value="233">ğŸ‡¬ğŸ‡­ +233</option>
            <option value="212">ğŸ‡²ğŸ‡¦ +212</option>
            <option value="213">ğŸ‡©ğŸ‡¿ +213</option>
            <option value="216">ğŸ‡¹ğŸ‡³ +216</option>
            <option value="971">ğŸ‡¦ğŸ‡ª +971</option>
            <option value="966">ğŸ‡¸ğŸ‡¦ +966</option>
            <option value="974">ğŸ‡¶ğŸ‡¦ +974</option>
            <option value="965">ğŸ‡°ğŸ‡¼ +965</option>
            <option value="973">ğŸ‡§ğŸ‡­ +973</option>
            <option value="968">ğŸ‡´ğŸ‡² +968</option>
            <option value="972">ğŸ‡®ğŸ‡± +972</option>
            <option value="90">ğŸ‡¹ğŸ‡· +90</option>
            <option value="98">ğŸ‡®ğŸ‡· +98</option>
            <option value="92">ğŸ‡µğŸ‡° +92</option>
            <option value="880">ğŸ‡§ğŸ‡© +880</option>
            <option value="91">ğŸ‡®ğŸ‡³ +91</option>
            <option value="94">ğŸ‡±ğŸ‡° +94</option>
            <option value="977">ğŸ‡³ğŸ‡µ +977</option>
            <option value="86">ğŸ‡¨ğŸ‡³ +86</option>
            <option value="81">ğŸ‡¯ğŸ‡µ +81</option>
            <option value="82">ğŸ‡°ğŸ‡· +82</option>
            <option value="65">ğŸ‡¸ğŸ‡¬ +65</option>
            <option value="60">ğŸ‡²ğŸ‡¾ +60</option>
            <option value="62">ğŸ‡®ğŸ‡© +62</option>
            <option value="66">ğŸ‡¹ğŸ‡­ +66</option>
            <option value="84">ğŸ‡»ğŸ‡³ +84</option>
            <option value="63">ğŸ‡µğŸ‡­ +63</option>
            <option value="55">ğŸ‡§ğŸ‡· +55</option>
            <option value="52">ğŸ‡²ğŸ‡½ +52</option>
            <option value="54">ğŸ‡¦ğŸ‡· +54</option>
            <option value="56">ğŸ‡¨ğŸ‡± +56</option>
            <option value="57">ğŸ‡¨ğŸ‡´ +57</option>
            <option value="51">ğŸ‡µğŸ‡ª +51</option>
          </select>

          <input
            class="form-control phone-number-input"
            type="tel"
            inputmode="numeric"
            autocomplete="tel-national"
            placeholder="Phone number"
          />
        </div>

        {% for e in producer_form.phone.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.password.id_for_label }}">Password</label>
        {{ producer_form.password }}
        {% if producer_form.password.help_text %}<small class="form-help">{{ producer_form.password.help_text }}</small>{% endif %}
        {% for e in producer_form.password.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.password_confirm.id_for_label }}">Confirm password</label>
        {{ producer_form.password_confirm }}
        {% for e in producer_form.password_confirm.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.business_name.id_for_label }}">Business name</label>
        {{ producer_form.business_name }}
        {% for e in producer_form.business_name.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.business_address.id_for_label }}">Business address</label>
        {{ producer_form.business_address }}
        {% for e in producer_form.business_address.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.postcode.id_for_label }}">Postcode</label>
        {{ producer_form.postcode }}
        {% for e in producer_form.postcode.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <button class="btn btn--primary" type="submit">Create producer account</button>
    </form>
  </div>

  <hr style="margin: 1.5rem 0;" />
  <p>Already registered? <a href="{% url 'accounts:login' %}">Login</a></p>
</section>

<script>
  (function () {
    const select = document.getElementById("accountType");
    const customer = document.getElementById("customerForm");
    const producer = document.getElementById("producerForm");

    function update() {
      const type = select.value;
      customer.style.display = (type === "customer") ? "block" : "none";
      producer.style.display = (type === "producer") ? "block" : "none";
    }
    select.addEventListener("change", update);
    update();

    function digitsOnly(s) {
      return (s || "").toString().replace(/[^\d]/g, "");
    }

    function wirePhone(kind) {
      const form = document.querySelector(`form[data-phone-form="${kind}"]`);
      if (!form) return;

      const djangoPhoneInput = form.querySelector('input[name$="-phone"], input[name="phone"]');
      const split = form.querySelector(`[data-phone-split="${kind}"]`);
      if (!djangoPhoneInput || !split) return;

      djangoPhoneInput.setAttribute("tabindex", "-1");

      const country = split.querySelector(".phone-country-select");
      const number = split.querySelector(".phone-number-input");

      if (djangoPhoneInput.value) {
        const allDigits = digitsOnly(djangoPhoneInput.value);
        const code = digitsOnly(country.value);
        number.value = allDigits.startsWith(code) ? allDigits.slice(code.length) : allDigits;
      }

      function sync() {
        const c = digitsOnly(country.value);
        const n = digitsOnly(number.value);
        djangoPhoneInput.value = (c || n) ? ("+" + c + n) : "";
      }

      country.addEventListener("change", sync);
      number.addEventListener("input", sync);
      form.addEventListener("submit", sync);

      sync();
    }

    function wireName(kind) {
      const form = document.querySelector(`form[data-name-form="${kind}"]`);
      if (!form) return;

      const hiddenName = kind === "customer"
        ? form.querySelector('input[name$="-full_name"], input[name="full_name"]')
        : form.querySelector('input[name$="-contact_name"], input[name="contact_name"]');

      const split = form.querySelector(`[data-name-split="${kind}"]`);
      if (!hiddenName || !split) return;

      hiddenName.setAttribute("tabindex", "-1");

      const first = split.querySelector(".first-name-input");
      const last  = split.querySelector(".last-name-input");

      if (hiddenName.value) {
        const parts = hiddenName.value.trim().split(/\s+/);
        first.value = parts.shift() || "";
        last.value = parts.join(" ");
      }

      function sync() {
        const f = (first.value || "").trim();
        const l = (last.value || "").trim();
        hiddenName.value = (f || l) ? (f + (l ? " " + l : "")) : "";
      }

      first.addEventListener("input", sync);
      last.addEventListener("input", sync);
      form.addEventListener("submit", sync);

      sync();
    }

    wirePhone("customer");
    wirePhone("producer");
    wireName("customer");
    wireName("producer");
  })();
</script>
{% endblock %}