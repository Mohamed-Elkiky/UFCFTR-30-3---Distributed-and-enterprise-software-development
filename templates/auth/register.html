{% extends "base.html" %}
{% load static %}
{% block title %}Register | BRFN{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/style.css' %}">

<style>
  /* Register-only layout (self-contained) */
  .page-register .phone-split {
    display: flex;
    align-items: center;
    gap: 12px;
    max-width: 520px;
  }

  .page-register .phone-country-select {
    width: 100px;
    min-width: 100px;
    padding: 14px 14px;
    font-size: 1.05rem;
    line-height: 1.2;
    border-radius: 10px;
  }

  .page-register .phone-number-input {
    flex: 1 1 auto;
    min-width: 180px;
    padding: 14px 14px; /* taller */
    font-size: 1.05rem;
    line-height: 1.2;
    border-radius: 10px;
  }

  .page-register .phone-country-select,
  .page-register .phone-number-input {
    box-sizing: border-box;
  }

  /* Name split */
  .page-register .name-split {
    display: flex;
    gap: 12px;
    max-width: 520px;
  }
  .page-register .name-split > div {
    flex: 1 1 0;
  }
  .page-register .name-input {
    padding: 14px 14px;
    font-size: 1.05rem;
    line-height: 1.2;
    border-radius: 10px;
  }

  /* Hide real Django fields (we fill via JS) */
  .page-register .hidden-field {
    display: none !important;
  }
</style>
{% endblock %}

{% block content %}
<section class="auth-card page-register">
  <h1>Register</h1>
  <p>Select the account type you want to create.</p>

  <div class="form-row">
    <label for="accountType">Account type</label>
    <select id="accountType" class="form-control">
      <option value="customer" selected>Customer (Individual)</option>
      <option value="producer">Producer</option>
    </select>
  </div>

  <!-- CUSTOMER -->
  <div id="customerForm">
    <h2>Customer details</h2>

    <form method="post" action="{% url 'accounts:register_customer' %}" novalidate data-phone-form="customer" data-name-form="customer">
      {% csrf_token %}

      {% if customer_form.non_field_errors %}
        <div class="message message--error" role="alert">
          {% for err in customer_form.non_field_errors %}{{ err }}{% endfor %}
        </div>
      {% endif %}

      <!-- NAME (UI split) -->
      <div class="form-row">
        <label>Name</label>

        <!-- real Django full_name (hidden) -->
        <div class="hidden-field django-fullname-field">
          {{ customer_form.full_name }}
        </div>

        <div class="name-split" data-name-split="customer">
          <div>
            <input class="form-control name-input first-name-input" type="text" placeholder="First name" autocomplete="given-name" />
          </div>
          <div>
            <input class="form-control name-input last-name-input" type="text" placeholder="Last name" autocomplete="family-name" />
          </div>
        </div>

        {% for e in customer_form.full_name.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <!-- EMAIL -->
      <div class="form-row">
        <label for="{{ customer_form.email.id_for_label }}">Email</label>
        {{ customer_form.email }}
        {% for e in customer_form.email.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <!-- PHONE (UI split) -->
      <div class="form-row">
        <label>Phone</label>

        <!-- real Django phone (hidden) -->
        <div class="hidden-field django-phone-field">
          {{ customer_form.phone }}
        </div>

        <div class="phone-split" data-phone-split="customer">
          <select class="form-control phone-country-select" autocomplete="tel-country-code">
            <option value="44" selected>ðŸ‡¬ðŸ‡§ +44</option>
            <option value="353">ðŸ‡®ðŸ‡ª +353</option>
            <option value="1">ðŸ‡ºðŸ‡¸ +1</option>
            <option value="33">ðŸ‡«ðŸ‡· +33</option>
            <option value="49">ðŸ‡©ðŸ‡ª +49</option>
            <option value="39">ðŸ‡®ðŸ‡¹ +39</option>
            <option value="34">ðŸ‡ªðŸ‡¸ +34</option>
            <option value="31">ðŸ‡³ðŸ‡± +31</option>
            <option value="32">ðŸ‡§ðŸ‡ª +32</option>
            <option value="20">ðŸ‡ªðŸ‡¬ +20</option>
            <option value="971">ðŸ‡¦ðŸ‡ª +971</option>
            <option value="966">ðŸ‡¸ðŸ‡¦ +966</option>
            <option value="90">ðŸ‡¹ðŸ‡· +90</option>
            <option value="92">ðŸ‡µðŸ‡° +92</option>
            <option value="880">ðŸ‡§ðŸ‡© +880</option>
            <option value="91">ðŸ‡®ðŸ‡³ +91</option>
          </select>

          <input
            class="form-control phone-number-input"
            type="tel"
            inputmode="numeric"
            autocomplete="tel-national"
            placeholder="Phone number"
          />
        </div>

        {% for e in customer_form.phone.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.password.id_for_label }}">Password</label>
        {{ customer_form.password }}
        {% if customer_form.password.help_text %}<small class="form-help">{{ customer_form.password.help_text }}</small>{% endif %}
        {% for e in customer_form.password.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.password_confirm.id_for_label }}">Confirm password</label>
        {{ customer_form.password_confirm }}
        {% for e in customer_form.password_confirm.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.delivery_address.id_for_label }}">Delivery address</label>
        {{ customer_form.delivery_address }}
        {% for e in customer_form.delivery_address.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ customer_form.postcode.id_for_label }}">Postcode</label>
        {{ customer_form.postcode }}
        {% for e in customer_form.postcode.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label>
          {{ customer_form.terms_accepted }} I accept the <a href="{% url 'accounts:terms_conditions' %}">terms and conditions</a>
        </label>
        {% for e in customer_form.terms_accepted.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <button class="btn" type="submit">Create customer account</button>
    </form>
  </div>

  <!-- PRODUCER -->
  <div id="producerForm" style="display:none;">
    <h2>Producer details</h2>

    <form method="post" action="{% url 'accounts:register_producer' %}" novalidate data-phone-form="producer" data-name-form="producer">
      {% csrf_token %}

      {% if producer_form.non_field_errors %}
        <div class="message message--error" role="alert">
          {% for err in producer_form.non_field_errors %}{{ err }}{% endfor %}
        </div>
      {% endif %}

      <!-- NAME (UI split) -->
      <div class="form-row">
        <label>Name</label>

        <div class="hidden-field django-fullname-field">
          {{ producer_form.contact_name }}
        </div>

        <div class="name-split" data-name-split="producer">
          <div>
            <input class="form-control name-input first-name-input" type="text" placeholder="First name" autocomplete="given-name" />
          </div>
          <div>
            <input class="form-control name-input last-name-input" type="text" placeholder="Last name" autocomplete="family-name" />
          </div>
        </div>

        {% for e in producer_form.contact_name.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.email.id_for_label }}">Email</label>
        {{ producer_form.email }}
        {% for e in producer_form.email.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <!-- PHONE (UI split) -->
      <div class="form-row">
        <label>Phone</label>

        <div class="hidden-field django-phone-field">
          {{ producer_form.phone }}
        </div>

        <div class="phone-split" data-phone-split="producer">
          <select class="form-control phone-country-select" autocomplete="tel-country-code">
            <option value="44" selected>ðŸ‡¬ðŸ‡§ +44</option>
            <option value="353">ðŸ‡®ðŸ‡ª +353</option>
            <option value="1">ðŸ‡ºðŸ‡¸ +1</option>
            <option value="33">ðŸ‡«ðŸ‡· +33</option>
            <option value="49">ðŸ‡©ðŸ‡ª +49</option>
            <option value="39">ðŸ‡®ðŸ‡¹ +39</option>
            <option value="34">ðŸ‡ªðŸ‡¸ +34</option>
            <option value="31">ðŸ‡³ðŸ‡± +31</option>
            <option value="32">ðŸ‡§ðŸ‡ª +32</option>
            <option value="20">ðŸ‡ªðŸ‡¬ +20</option>
            <option value="971">ðŸ‡¦ðŸ‡ª +971</option>
            <option value="966">ðŸ‡¸ðŸ‡¦ +966</option>
            <option value="90">ðŸ‡¹ðŸ‡· +90</option>
            <option value="92">ðŸ‡µðŸ‡° +92</option>
            <option value="880">ðŸ‡§ðŸ‡© +880</option>
            <option value="91">ðŸ‡®ðŸ‡³ +91</option>
          </select>

          <input
            class="form-control phone-number-input"
            type="tel"
            inputmode="numeric"
            autocomplete="tel-national"
            placeholder="Phone number"
          />
        </div>

        {% for e in producer_form.phone.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.password.id_for_label }}">Password</label>
        {{ producer_form.password }}
        {% if producer_form.password.help_text %}<small class="form-help">{{ producer_form.password.help_text }}</small>{% endif %}
        {% for e in producer_form.password.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.password_confirm.id_for_label }}">Confirm password</label>
        {{ producer_form.password_confirm }}
        {% for e in producer_form.password_confirm.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.business_name.id_for_label }}">Business name</label>
        {{ producer_form.business_name }}
        {% for e in producer_form.business_name.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.business_address.id_for_label }}">Business address</label>
        {{ producer_form.business_address }}
        {% for e in producer_form.business_address.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <div class="form-row">
        <label for="{{ producer_form.postcode.id_for_label }}">Postcode</label>
        {{ producer_form.postcode }}
        {% for e in producer_form.postcode.errors %}<div class="form-error">{{ e }}</div>{% endfor %}
      </div>

      <button class="btn" type="submit">Create producer account</button>
    </form>
  </div>

  <hr style="margin: 1.5rem 0;" />
  <p>Already registered? <a href="{% url 'accounts:login' %}">Login</a></p>
</section>

<script>
  (function () {
    // Toggle form blocks
    const select = document.getElementById("accountType");
    const customer = document.getElementById("customerForm");
    const producer = document.getElementById("producerForm");

    function update() {
      const type = select.value;
      customer.style.display = (type === "customer") ? "block" : "none";
      producer.style.display = (type === "producer") ? "block" : "none";
    }
    select.addEventListener("change", update);
    update();

    function digitsOnly(s) {
      return (s || "").toString().replace(/[^\d]/g, "");
    }

    function wirePhone(kind) {
      const form = document.querySelector(`form[data-phone-form="${kind}"]`);
      if (!form) return;

      const djangoPhoneInput = form.querySelector('input[name$="-phone"], input[name="phone"]');
      const split = form.querySelector(`[data-phone-split="${kind}"]`);
      if (!djangoPhoneInput || !split) return;

      djangoPhoneInput.setAttribute("tabindex", "-1");

      const country = split.querySelector(".phone-country-select");
      const number = split.querySelector(".phone-number-input");

      if (djangoPhoneInput.value) {
        const allDigits = digitsOnly(djangoPhoneInput.value);
        const code = digitsOnly(country.value);
        number.value = allDigits.startsWith(code) ? allDigits.slice(code.length) : allDigits;
      }

      function sync() {
        const c = digitsOnly(country.value);
        const n = digitsOnly(number.value);
        djangoPhoneInput.value = (c || n) ? ("+" + c + n) : "";
      }

      country.addEventListener("change", sync);
      number.addEventListener("input", sync);
      form.addEventListener("submit", sync);

      sync();
    }

    function wireName(kind) {
      const form = document.querySelector(`form[data-name-form="${kind}"]`);
      if (!form) return;

      // Customer uses full_name; Producer uses contact_name (per your template)
      const hiddenName = kind === "customer"
        ? form.querySelector('input[name$="-full_name"], input[name="full_name"]')
        : form.querySelector('input[name$="-contact_name"], input[name="contact_name"]');

      const split = form.querySelector(`[data-name-split="${kind}"]`);
      if (!hiddenName || !split) return;

      hiddenName.setAttribute("tabindex", "-1");

      const first = split.querySelector(".first-name-input");
      const last  = split.querySelector(".last-name-input");

      // If re-rendered with value, try split on first space
      if (hiddenName.value) {
        const parts = hiddenName.value.trim().split(/\s+/);
        first.value = parts.shift() || "";
        last.value = parts.join(" ");
      }

      function sync() {
        const f = (first.value || "").trim();
        const l = (last.value || "").trim();
        hiddenName.value = (f || l) ? (f + (l ? " " + l : "")) : "";
      }

      first.addEventListener("input", sync);
      last.addEventListener("input", sync);
      form.addEventListener("submit", sync);

      sync();
    }

    wirePhone("customer");
    wirePhone("producer");
    wireName("customer");
    wireName("producer");
  })();
</script>
{% endblock %}