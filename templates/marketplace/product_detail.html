{% extends "base.html" %}
{% block content %}
<div class="product-detail-container">
  <h1>{{ product.name|default:"Product" }}</h1>

  {% if product %}
    <div class="product-detail-info">
      <p><strong>Price:</strong> {{ product.price_display }}</p>
      
      {% if product.description %}
        <p class="product-description">{{ product.description }}</p>
      {% endif %}

      {% if product.producer %}
        <p><strong>Producer:</strong> {{ product.producer.business_name }}</p>
      {% endif %}

      {% if product.category %}
        <p><strong>Category:</strong> {{ product.category.name }}</p>
      {% endif %}

      <p><strong>Unit:</strong> {{ product.unit }}</p>
      
      <p><strong>Availability:</strong> {{ product.get_availability_display }}</p>

      {% if product.organic_certified %}
        <p class="organic-badge"><strong>üåø Certified Organic</strong></p>
      {% endif %}

      {% if product.harvest_date %}
        <p><strong>Harvest Date:</strong> {{ product.harvest_date|date:"j M Y" }}</p>
      {% endif %}

      {% if product.best_before_date %}
        <p><strong>Best Before:</strong> {{ product.best_before_date|date:"j M Y" }}</p>
      {% endif %}

      {% if product.stock_qty > 0 %}
        <p><strong>In Stock:</strong> {{ product.stock_qty }} {{ product.unit }}</p>
      {% else %}
        <p class="out-of-stock"><strong>Out of Stock</strong></p>
      {% endif %}
    </div>

    <!-- Add to Basket -->
    {% if product.stock_qty > 0 %}
      {% if user.is_authenticated and user.is_customer %}
        <form method="post" action="{% url 'cart:cart_add' product.pk %}" class="add-to-basket-form">
          {% csrf_token %}
          <div class="qty-row">
            <label for="qty">Quantity:</label>
            <input type="number" id="qty" name="quantity" value="1" min="1" max="{{ product.stock_qty }}" class="qty-input">
          </div>
          <button type="submit" class="btn btn--primary btn--lg">Add to Basket</button>
        </form>
      {% elif user.is_authenticated %}
        <p class="muted">Only customer accounts can add items to a basket.</p>
      {% else %}
        <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn--primary btn--lg">Login to add to basket</a>
      {% endif %}
    {% endif %}

    <!-- Allergen Warning Section (TC-015) -->
    <div class="allergen-section">
      <h3>‚ö†Ô∏è Allergen Information</h3>
      {% if allergens %}
        <div class="allergen-warning">
          <p><strong>Contains:</strong></p>
          <ul class="allergen-list">
            {% for pa in allergens %}
              <li class="allergen-item">{{ pa.allergen.name }}</li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <p class="no-allergens">No common allergens.</p>
      {% endif %}
      <p class="allergen-note"><small>For full allergen information, please contact the producer.</small></p>
    </div>

    <!-- Product Images -->
    {% if images %}
      <div class="product-images">
        <h3>Product Images</h3>
        {% for image in images %}
          <img src="{{ image.url }}" alt="{{ product.name }}" class="product-image">
        {% endfor %}
      </div>
    {% endif %}

    <p class="back-link">
      <a href="{% url 'marketplace:home' %}">‚Üê Back to marketplace</a>
    </p>
  {% else %}
    <p>Product not available.</p>
  {% endif %}
</div>

<style>
  .product-detail-container { max-width: 800px; margin: 0 auto; padding: 20px; }
  .product-detail-info { margin-bottom: 20px; }
  .product-description { color: #666; margin: 15px 0; }
  .organic-badge { color: #2e7d32; }
  .out-of-stock { color: #d32f2f; }
  
  .allergen-section {
    background: #fff3cd;
    border: 2px solid #ffc107;
    border-radius: 8px;
    padding: 15px 20px;
    margin: 20px 0;
  }
  .allergen-section h3 { margin-top: 0; color: #856404; }
  .allergen-warning { background: #fff; padding: 10px; border-radius: 4px; }
  .allergen-list { margin: 10px 0; padding-left: 20px; }
  .allergen-item { color: #d32f2f; font-weight: 500; margin: 5px 0; }
  .no-allergens { color: #2e7d32; font-weight: 500; }
  .allergen-note { color: #666; margin-top: 10px; }
  
  .product-images { margin: 20px 0; }
  .product-image { max-width: 300px; margin: 10px 10px 10px 0; border-radius: 8px; }
  .back-link { margin-top: 20px; }
  .add-to-basket-form { margin: 20px 0; }
  .qty-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
  .qty-input { width: 70px; padding: 6px 8px; border: 1px solid #ccc; border-radius: 4px; font: inherit; }
  .btn--lg { padding: .7rem 1.6rem; font-size: 1rem; }
</style>
{% endblock %}