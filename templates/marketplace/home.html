{% extends "base.html" %}
{% load static %}

{% block body_class %}page-home
  <style>
    .product-card-actions { padding: 0 1rem 1rem; }
    .product-card-actions form, .product-card-actions a { display: block; }
    .btn--full { width: 100%; text-align: center; box-sizing: border-box; }
  </style>
{% endblock %}

{% block content %}
  <!-- Hero Section -->
  <section class="hero">
    <div class="hero-content">
      <span class="hero-badge">Fresh Local Produce</span>
      <h1 class="hero-title">Bristol Regional Food Network</h1>
      <p class="hero-subtitle">Connecting local farmers with your table ‚Äî within 20 miles of Bristol</p>
    </div>
  </section>

  <!-- Search & Filter Section -->
  <section class="search-filter-section">
    <form class="search-filter-form" action="" method="get" id="filter-form">
      <!-- Hidden category field, set by pill clicks -->
      <input type="hidden" name="category" id="category-input" value="{{ selected_category }}">

      <!-- Main Search Bar -->
      <div class="search-bar-wrapper">
        <svg class="search-bar-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input type="search" name="q" class="search-bar-input" placeholder="Search products, producers, or keywords..." value="{{ q }}">
        <button type="submit" class="search-bar-btn">Search</button>
      </div>

      <!-- Category Filter Pills -->
      <div class="filter-categories">
        <span class="filter-label">Browse:</span>
        <div class="category-pills">
          <button type="button" class="category-pill {% if not selected_category %}active{% endif %}" data-category="">
            <span>All Products</span>
          </button>
          {% for cat in categories %}
          <button type="button" class="category-pill {% if selected_category == cat.id|stringformat:"d" %}active{% endif %}" data-category="{{ cat.id }}">
            <span class="pill-icon">
              {% if cat.name == "Vegetables" %}ü•¨
              {% elif cat.name == "Fruit" %}üçé
              {% elif cat.name == "Dairy" %}ü•õ
              {% elif cat.name == "Bakery" %}üçû
              {% elif cat.name == "Meat" %}ü•©
              {% elif cat.name == "Preserves" %}üçØ
              {% elif cat.name == "Seasonal Specialities" %}üå±
              {% else %}üõí{% endif %}
            </span>
            <span>{{ cat.name }}</span>
          </button>
          {% endfor %}
        </div>
      </div>

      <!-- Additional Filters -->
      <div class="filter-row">
        <div class="filter-group">
          <label class="filter-group-label">Dietary:</label>
          <div class="filter-checkboxes">
            <label class="filter-checkbox">
              <input type="checkbox" name="organic" value="1" {% if filter_organic %}checked{% endif %}>
              <span class="checkbox-custom"></span>
              <span>Organic Only</span>
            </label>
          </div>
        </div>
        <div class="filter-group">
          <label class="filter-group-label">Availability:</label>
          <div class="filter-checkboxes">
            <label class="filter-checkbox">
              <input type="checkbox" name="in_season" value="1" {% if filter_in_season %}checked{% endif %}>
              <span class="checkbox-custom"></span>
              <span>In Season</span>
            </label>
          </div>
        </div>
      </div>
    </form>
  </section>

  <script>
    // Category pill clicks set the hidden input and submit the form
    document.querySelectorAll('.category-pill').forEach(function(pill) {
      pill.addEventListener('click', function() {
        document.getElementById('category-input').value = this.dataset.category;
        document.getElementById('filter-form').submit();
      });
    });
  </script>

  <!-- Featured Products Section -->
  <section class="products-section">
    <div class="section-header">
      <h2 class="section-title">Featured Products</h2>
      <p class="section-subtitle">Handpicked seasonal items from local producers</p>
    </div>

    <div class="product-grid">
      {% for product in products %}
      <article class="product-card">
        <a href="{% url 'marketplace:product_detail' product.pk %}" class="product-card-link">
          <div class="product-image">
            <div class="product-image-placeholder">
              <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Z"/><path d="M12 6v6l4 2"/></svg>
            </div>
            {% if product.organic_certified %}
              <span class="product-badge badge-organic">Organic</span>
            {% endif %}
          </div>
          <div class="product-info">
            {% if product.category %}
              <span class="product-category">{{ product.category.name }}</span>
            {% endif %}
            <h3 class="product-name">{{ product.name }}</h3>
            {% if product.producer %}
              <p class="product-producer">{{ product.producer.business_name }}</p>
            {% endif %}
            <p class="product-description">{{ product.description|truncatewords:20 }}</p>
            <div class="product-meta">
              {% if product.harvest_date %}
                <span class="product-harvest">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                  Harvested: {{ product.harvest_date|date:"j M Y" }}
                </span>
              {% endif %}
              {% if product.best_before_date %}
                <span class="product-best-before">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  Best before: {{ product.best_before_date|date:"j M Y" }}
                </span>
              {% endif %}
            </div>
            {% with allergens=product.allergen_links.all %}
              {% if allergens %}
                <div class="product-allergens">
                  {% for link in allergens %}
                    <span class="allergen-badge allergen-contains" title="Contains {{ link.allergen.name }}">{{ link.allergen.name|truncatechars:4|upper }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            <div class="product-footer">
              <span class="product-price">{{ product.price_display }} <span class="product-unit">/ {{ product.unit }}</span></span>
              <span class="product-availability
                {% if product.availability == 'in_season' %}availability-in-season
                {% elif product.availability == 'available_year_round' %}availability-available
                {% else %}availability-unavailable{% endif %}">
                {% if product.availability == 'in_season' %}In Season
                {% elif product.availability == 'available_year_round' %}Available
                {% else %}{{ product.get_availability_display }}{% endif %}
              </span>
            </div>
          </div>
        </a>
        <div class="product-card-actions">
          {% if user.is_authenticated and user.is_customer %}
            <form method="post" action="{% url 'cart:cart_add' product.pk %}">
              {% csrf_token %}
              <input type="hidden" name="quantity" value="1">
              <button type="submit" class="btn btn--primary btn--full">Add to Basket</button>
            </form>
          {% elif user.is_authenticated %}
            {# Producer/admin accounts do not have a basket #}
          {% else %}
            <a href="{% url 'accounts:login' %}?next={{ request.path }}" class="btn btn--ghost btn--full">Login to add</a>
          {% endif %}
        </div>
      </article>
      {% empty %}
        <p class="no-products">No products available at the moment.</p>
      {% endfor %}
    </div>
  </section>

  <!-- Surplus Deals Teaser -->
  <section class="surplus-section">
    <div class="surplus-banner">
      <div class="surplus-content">
        <span class="surplus-icon">üå±</span>
        <div class="surplus-text">
          <h3 class="surplus-title">Help Reduce Food Waste</h3>
          <p class="surplus-description">Check out our surplus deals ‚Äî discounted items from local producers to prevent waste.</p>
        </div>
        <a href="#" class="btn btn--ghost">View Surplus Deals</a>
      </div>
    </div>
  </section>
{% endblock %}