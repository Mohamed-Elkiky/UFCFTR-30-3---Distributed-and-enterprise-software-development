{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}BRFN Marketplace{% endblock %}</title>

  <!-- Theme initialization (prevents flash) -->
  <script>
    (function() {
      const theme = localStorage.getItem('theme') || 'light';
      if (theme === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  {% block extra_head %}{% endblock %}
</head>

<body class="{% block body_class %}{% endblock %}">

  <!-- =============================================================== -->
  <!-- HEADER / NAV                                                    -->
  <!-- =============================================================== -->
  <header class="site-header">
    <nav class="site-nav" aria-label="Primary navigation">
      <!-- Brand -->
      <a class="brand" href="{% url 'marketplace:home' %}">
        <span class="brand-text">BRFN</span>
        <span class="brand-dot"></span>
      </a>

      {% block nav_links %}{% endblock %}

      <span class="nav-spacer" aria-hidden="true"></span>

      <!-- Header search -->
      <form class="nav-search" action="{% url 'marketplace:home' %}" method="get" role="search" aria-label="Search products">
        <label class="sr-only" for="nav-q">Search</label>
        {% if category %}<input type="hidden" name="category" value="{{ category }}" />{% endif %}
        {% if organic %}<input type="hidden" name="organic" value="1" />{% endif %}
        {% if allergen %}<input type="hidden" name="allergen" value="{{ allergen }}" />{% endif %}
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        <input
          id="nav-q"
          name="q"
          type="search"
          value="{{ q|default:'' }}"
          placeholder="Search products..."
          aria-label="Search products"
        />
        <button type="submit" class="search-btn">
          <span>Search</span>
        </button>
      </form>

      <!-- Cart -->
      <a class="nav-cart" href="{% url 'cart:cart_detail' %}" aria-label="Shopping cart">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>
        <span class="cart-badge" aria-label="Items in cart">{{ cart_count|default:"0" }}</span>
      </a>

      <!-- Theme Toggle -->
      <button class="theme-toggle" id="theme-toggle" aria-label="Toggle dark mode" title="Toggle dark/light mode">
        <!-- Sun icon (light mode indicator) -->
        <span class="theme-toggle-option icon-sun-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </span>
        <!-- Moon icon (dark mode indicator) -->
        <span class="theme-toggle-option icon-moon-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
        </span>
      </button>

      <!-- Divider -->
      <span class="nav-divider"></span>

      <!-- Auth links -->
      {% if user.is_authenticated %}
        <div class="nav-user">
          <span class="nav-greeting">{{ user.email }}</span>
          <div class="nav-links">
            <a class="nav-link" href="{% url 'accounts:dashboard' %}">Dashboard</a>
            {% if user.is_producer %}
              <a class="nav-link" href="{% url 'accounts:producer_dashboard' %}">Producer</a>
            {% elif user.is_customer %}
              <a class="nav-link" href="{% url 'accounts:customer_dashboard' %}">Customer</a>
            {% endif %}
            <a class="nav-link nav-link--logout" href="{% url 'accounts:logout' %}">Logout</a>
          </div>
        </div>
      {% else %}
        <div class="nav-auth">
          <a class="nav-link" href="{% url 'accounts:login' %}">Login</a>
          <a class="nav-link nav-link--primary" href="{% url 'accounts:register' %}">Register</a>
        </div>
      {% endif %}

      {% block nav_right %}{% endblock %}
    </nav>
  </header>

  <!-- =============================================================== -->
  <!-- MAIN                                                            -->
  <!-- =============================================================== -->
  <main id="content" class="site-main">

    {% if messages %}
      <div class="messages" aria-live="polite" aria-atomic="true">
        {% for message in messages %}
          <div class="message {% if message.tags %}message--{{ message.tags }}{% endif %}" role="alert">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}

      <!-- =========================================================== -->
      <!-- HERO + PRIMARY SEARCH                                       -->
      <!-- =========================================================== -->
      <section class="home-hero" aria-label="Marketplace introduction">
        <div class="home-hero__inner">
          <h1 class="home-hero__title">Local food, direct from producers.</h1>
          <p class="home-hero__sub">
            Browse by category. Search by product name, description keywords, or producer.
          </p>

          <form class="home-search" action="{% url 'marketplace:home' %}" method="get" role="search" aria-label="Search marketplace">
            <label class="sr-only" for="home-q">Search products</label>
            {% if category %}<input type="hidden" name="category" value="{{ category|urlencode }}" />{% endif %}
            {% if organic %}<input type="hidden" name="organic" value="1" />{% endif %}
            {% if allergen %}<input type="hidden" name="allergen" value="{{ allergen|urlencode }}" />{% endif %}
            <input
              id="home-q"
              name="q"
              type="search"
              value="{{ q|default:'' }}"
              placeholder="Search: apples, sourdough, local honey, farm name…"
            />
            <button type="submit" class="btn btn--primary">Search</button>
          </form>

          <div class="home-actions">
            <a class="btn btn--primary" href="{% url 'marketplace:home' %}#categories">Browse categories</a>
            <a class="btn btn--ghost" href="{% url 'marketplace:home' %}#surplus">View surplus deals</a>
          </div>
        </div>
      </section>

      <!-- =========================================================== -->
      <!-- CATEGORY TILES (Critical)                                   -->
      <!-- =========================================================== -->
      <section id="categories" class="home-categories" aria-label="Browse by category">
        <h2>Shop by category</h2>

        {% if categories %}
          <div class="category-grid">
            {% for c in categories %}
              <a class="category-card" href="{% url 'marketplace:home' %}?category={{ c.slug|default:c.name|urlencode }}">
                <strong>{{ c.name }}</strong>
                {% if c.description %}<span>{{ c.description }}</span>{% endif %}
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="category-grid">
            <a class="category-card" href="{% url 'marketplace:home' %}?category=vegetables"><strong>Vegetables</strong><span>Fresh &amp; seasonal</span></a>
            <a class="category-card" href="{% url 'marketplace:home' %}?category=dairy-eggs"><strong>Dairy &amp; Eggs</strong><span>Milk, cheese, eggs</span></a>
            <a class="category-card" href="{% url 'marketplace:home' %}?category=bakery"><strong>Bakery</strong><span>Bread, pastries</span></a>
            <a class="category-card" href="{% url 'marketplace:home' %}?category=preserves"><strong>Preserves</strong><span>Jams, pickles, sauces</span></a>
            <a class="category-card" href="{% url 'marketplace:home' %}?category=seasonal"><strong>Seasonal Specialities</strong><span>Limited runs</span></a>
          </div>
        {% endif %}
      </section>

      <!-- =========================================================== -->
      <!-- QUICK FILTERS (Organic / Allergens)                         -->
      <!-- =========================================================== -->
      <section class="home-filters" aria-label="Quick filters">
        <div class="filter-bar">

          
            class="btn btn--ghost btn--sm {% if organic %}btn--active{% endif %}"
            href="{% url 'marketplace:home' %}?organic=1{% if q %}&amp;q={{ q|urlencode }}{% endif %}{% if category %}&amp;category={{ category|urlencode }}{% endif %}{% if allergen %}&amp;allergen={{ allergen|urlencode }}{% endif %}"
            aria-label="Show organic products only"
          >
            Organic only
          </a>

          <form class="filter-form" action="{% url 'marketplace:home' %}" method="get" aria-label="Filter by allergen">
            {% if q %}<input type="hidden" name="q" value="{{ q|urlencode }}" />{% endif %}
            {% if category %}<input type="hidden" name="category" value="{{ category|urlencode }}" />{% endif %}
            {% if organic %}<input type="hidden" name="organic" value="1" />{% endif %}

            <label class="sr-only" for="allergen-filter">Filter by allergen</label>
            <select id="allergen-filter" name="allergen" class="select select--sm" onchange="this.form.submit()">
              <option value="">Allergen filter…</option>
              <option value="gluten"{% if allergen == "gluten" %} selected{% endif %}>Gluten-free</option>
              <option value="dairy"{% if allergen == "dairy" %} selected{% endif %}>Dairy-free</option>
              <option value="nuts"{% if allergen == "nuts" %} selected{% endif %}>Nut-free</option>
              <option value="eggs"{% if allergen == "eggs" %} selected{% endif %}>Egg-free</option>
              <option value="soy"{% if allergen == "soy" %} selected{% endif %}>Soy-free</option>
            </select>
            <noscript><button type="submit" class="btn btn--sm">Apply</button></noscript>
          </form>
        </div>
      </section>

      <!-- =========================================================== -->
      <!-- PRODUCT GRID HELPERS (inline, no extra files)               -->
      <!-- =========================================================== -->
      {% if q %}
        <section class="home-search-results" aria-label="Search results">
          <h2>Results for "{{ q }}"</h2>

          {% if search_results %}
            <div class="product-grid">
              {% for product in search_results %}
                <article class="product-card">
                  <a class="product-card__link" href="{{ product.get_absolute_url|default:'#' }}">
                    <h3 class="product-title">{{ product.name }}</h3>
                  </a>
                  <div class="product-meta">
                    {% if product.discount_price %}
                      <div class="product-price">
                        <strong>&pound;{{ product.discount_price }}</strong>
                        {% if product.price %}<span class="price-was">was &pound;{{ product.price }}</span>{% endif %}
                      </div>
                    {% elif product.price %}
                      <div class="product-price">&pound;{{ product.price }}</div>
                    {% else %}
                      <div class="product-price muted">Price unavailable</div>
                    {% endif %}
                    {% if product.producer_name %}
                      <div><strong>Producer:</strong> {{ product.producer_name }}</div>
                    {% elif product.producer %}
                      <div><strong>Producer:</strong> {{ product.producer }}</div>
                    {% endif %}
                    {% if product.origin %}
                      <div><strong>Origin:</strong> {{ product.origin }}</div>
                    {% endif %}
                    <span class="badge {% if product.is_in_season %}badge--good{% elif product.is_in_season == False %}badge--muted{% endif %}">
                      {% if product.is_in_season %}In Season
                      {% elif product.is_in_season == False %}Unavailable
                      {% elif product.season_label %}{{ product.season_label }}
                      {% else %}Year-round{% endif %}
                    </span>
                  </div>
                </article>
              {% endfor %}
            </div>
          {% else %}
            <div class="no-results">
              <p>No results found. Try a different keyword or browse categories.</p>
              <a class="btn btn--ghost" href="{% url 'marketplace:home' %}#categories">Browse categories</a>
            </div>
          {% endif %}
        </section>
      {% endif %}

      <!-- =========================================================== -->
      <!-- FEATURED PRODUCTS                                           -->
      <!-- =========================================================== -->
      <section class="home-featured" aria-label="Featured products">
        <h2>Featured</h2>

        {% if featured_products %}
          <div class="product-grid">
            {% for product in featured_products %}
              <article class="product-card">
                <a class="product-card__link" href="{{ product.get_absolute_url|default:'#' }}">
                  <h3 class="product-title">{{ product.name }}</h3>
                </a>
                <div class="product-meta">
                  {% if product.discount_price %}
                    <div class="product-price">
                      <strong>&pound;{{ product.discount_price }}</strong>
                      {% if product.price %}<span class="price-was">was &pound;{{ product.price }}</span>{% endif %}
                    </div>
                  {% elif product.price %}
                    <div class="product-price">&pound;{{ product.price }}</div>
                  {% else %}
                    <div class="product-price muted">Price unavailable</div>
                  {% endif %}
                  {% if product.producer_name %}
                    <div><strong>Producer:</strong> {{ product.producer_name }}</div>
                  {% elif product.producer %}
                    <div><strong>Producer:</strong> {{ product.producer }}</div>
                  {% endif %}
                  {% if product.origin %}
                    <div><strong>Origin:</strong> {{ product.origin }}</div>
                  {% endif %}
                  <span class="badge {% if product.is_in_season %}badge--good{% elif product.is_in_season == False %}badge--muted{% endif %}">
                    {% if product.is_in_season %}In Season
                    {% elif product.is_in_season == False %}Unavailable
                    {% elif product.season_label %}{{ product.season_label }}
                    {% else %}Year-round{% endif %}
                  </span>
                </div>
              </article>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">Featured products will appear here soon.</p>
        {% endif %}
      </section>

      <!-- =========================================================== -->
      <!-- SURPLUS / LAST-MINUTE DEALS                                 -->
      <!-- =========================================================== -->
      <section id="surplus" class="home-surplus" aria-label="Surplus deals">
        <h2>Surplus / Last-minute deals</h2>
        <p class="muted">Discounted items to help reduce waste.</p>

        {% if surplus_products %}
          <div class="product-grid">
            {% for product in surplus_products %}
              <article class="product-card product-card--deal">
                <a class="product-card__link" href="{{ product.get_absolute_url|default:'#' }}">
                  <h3 class="product-title">{{ product.name }}</h3>
                </a>
                <div class="product-meta">
                  {% if product.discount_price %}
                    <div class="product-price">
                      <strong>&pound;{{ product.discount_price }}</strong>
                      {% if product.price %}<span class="price-was">was &pound;{{ product.price }}</span>{% endif %}
                    </div>
                  {% elif product.price %}
                    <div class="product-price">&pound;{{ product.price }}</div>
                  {% else %}
                    <div class="product-price muted">Price unavailable</div>
                  {% endif %}
                  {% if product.best_before %}
                    <div><strong>Best before:</strong> {{ product.best_before }}</div>
                  {% endif %}
                  {% if product.producer_name %}
                    <div><strong>Producer:</strong> {{ product.producer_name }}</div>
                  {% elif product.producer %}
                    <div><strong>Producer:</strong> {{ product.producer }}</div>
                  {% endif %}
                  {% if product.origin %}
                    <div><strong>Origin:</strong> {{ product.origin }}</div>
                  {% endif %}
                  <span class="badge {% if product.is_in_season %}badge--good{% elif product.is_in_season == False %}badge--muted{% endif %}">
                    {% if product.is_in_season %}In Season
                    {% elif product.is_in_season == False %}Unavailable
                    {% elif product.season_label %}{{ product.season_label }}
                    {% else %}Year-round{% endif %}
                  </span>
                </div>
              </article>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">Surplus deals will appear here when producers list discounted stock.</p>
        {% endif %}
      </section>

      <!-- =========================================================== -->
      <!-- FOOD MILES HOOK                                             -->
      <!-- =========================================================== -->
      <section id="food-miles" class="home-food-miles" aria-label="Food miles">
        <h2>Food miles</h2>
        {% if user_postcode %}
          <p>Using postcode: <strong>{{ user_postcode }}</strong></p>
        {% elif user.is_authenticated %}
          <p>Add your postcode in your profile to calculate food miles.</p>
        {% else %}
          <p>Log in and add a postcode in your profile to see food miles.</p>
        {% endif %}
      </section>

      <!-- =========================================================== -->
      <!-- COMMUNITY LINKS                                             -->
      <!-- =========================================================== -->
      <section class="home-community" aria-label="Community and education">
        <h2>Community</h2>
        <div class="community-grid">
          <a class="community-link card" href="{% url 'marketplace:home' %}#recipes">
            <strong>Recipes</strong><span>Seasonal inspiration</span>
          </a>
          <a class="community-link card" href="{% url 'marketplace:home' %}#farm-stories">
            <strong>Farm Stories</strong><span>Meet producers</span>
          </a>
          <a class="community-link card" href="{% url 'marketplace:home' %}#storage-guides">
            <strong>Storage Guides</strong><span>Keep food fresh</span>
          </a>
        </div>
      </section>

      <div id="cart" aria-hidden="true"></div>
      <div id="recipes" aria-hidden="true"></div>
      <div id="farm-stories" aria-hidden="true"></div>
      <div id="storage-guides" aria-hidden="true"></div>

    {% endblock %}
  </main>

  <!-- =============================================================== -->
  <!-- FOOTER                                                          -->
  <!-- =============================================================== -->
  <footer class="site-footer">
    <small>&copy; {% now "Y" %} BRFN Marketplace</small>
  </footer>

  {% block extra_js %}{% endblock %}

  <!-- Theme Toggle Script -->
  <script>
    (function() {
      const toggle = document.getElementById('theme-toggle');
      if (!toggle) return;

      toggle.addEventListener('click', function() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        if (newTheme === 'dark') {
          html.setAttribute('data-theme', 'dark');
        } else {
          html.removeAttribute('data-theme');
        }

        localStorage.setItem('theme', newTheme);
      });
    })();
  </script>
</body>
</html>